<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/paper-styles.html">

<dom-module id="paper-select">
  <template>
    <style>
      :host {
        display: block;

        --paper-select-primary-color: var(--paper-grey-600);
        --paper-select-primary-disabled-color: var(--paper-grey-400);
        --paper-select-primary-white-color: var(--paper-grey-50);
        
        --paper-select-secondary-color: var(--paper-indigo-600);
        --paper-select-secondary-disabled-color: var(--paper-indigo-300);
        --paper-select-secondary-white-color: var(--paper-indigo-50);
        
        --paper-select-third-color: var(--paper-pink-600);
        --paper-select-third-disabled-color: var(--paper-pink-300);
        
        --paper-select-fourth-color: var(--paper-red-600);
        --paper-select-fourth-disabled-color: var(--paper-red-600);
      }

      div#selected {
        position: relative;
        flex-direction: row;
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px var(--paper-select-primary-color) solid;
        min-height: 32px;
      }

      div#selected label#label {
        color: var(--paper-select-primary-color);
        display: block;
        margin: 2px;
        padding: 8px 0;
        width: 100%;
      }

      div#selected[focused] {
        border-bottom: 2px var(--paper-select-secondary-color) solid;
      }

      div#selected[focused] label#label {
        color: var(--paper-select-secondary-color);
      }

      :host([disabled]) div#selected {
        border-bottom: 1px var(--paper-select-primary-disabled-color) dashed;
      }

      :host([disabled]) div#selected label#label {
        color: var(--paper-select-primary-disabled-color);
      }
      
      :host([disabled]) paper-ripple {
        display: none;
      }

      :host([invalid]) div#selected {
        border-bottom: 2px var(--paper-select-fourth-disabled-color) solid;
      }

      :host([invalid]) div#selected label#label {
        color: var(--paper-select-fourth-disabled-color);
      }

      div#selected div.item {
        @apply --shadow-elevation-2dp;
        background-color: var(--paper-select-secondary-color);
        color: var(--paper-select-secondary-white-color);
        margin: 2px;
        padding: 8px;
        border-radius: 4px;
        display: flex;
      }

      div#selected div.item span.clear {
        margin-left: 3px;
        color: var(--paper-select-third-color);
        cursor: pointer;
        --iron-icon-width: 14px;
        --iron-icon-height: 14px;
        --iron-icon: {
          font-weight: bold;
        };
      }

      :host([disabled]) div#selected div.item {
        background-color: var(--paper-select-secondary-disabled-color);
      }

      :host([disabled]) div#selected div.item span.clear {
        color: var(--paper-select-third-disabled-color);
        cursor: default;
      }

      iron-dropdown#dropdown {
        @apply --shadow-elevation-4dp;
        background-color: var(--paper-select-primary-white-color);
        padding: 0 2px 2px;
      }

      iron-dropdown paper-input iron-icon {
        color: var(--paper-select-primary-color);
      }

      ::slotted([selected]) {
        font-weight: bold;
      }      
    </style>

    <div id="selected" slot="dropdown-trigger" on-tap="open" focused$="{{ focused }}">
      <label id="label">{{ label }}</label>
      <dom-repeat items="{{ selectedItems }}" id="selected_items">
        <template>
          <div class="item">
            <span class="content">{{ item.label }}</span>
            <span class="clear">
              <iron-icon icon="close"
                         slot="prefix"
                         value$="{{ item.value }}"
                         on-tap="onDelete">
              </iron-icon>
            </span>
            <paper-ripple></paper-ripple>
          </div>
        </template>
      </dom-repeat>
      <paper-ripple></paper-ripple>
    </div>
    
    <iron-dropdown no-overlap horizontal-align="left" vertical-align="top" id="dropdown" on-iron-overlay-closed="close">
      <div slot="dropdown-content">
        <paper-input value="{{ searchText }}" hidden$="{{ !searchable }}" no-label-float type="text">
          <iron-icon icon="search" slot="prefix"></iron-icon>
        </paper-input>
        <div role="listbox">
          <slot id="slot"></slot>
        </div>
      </div>
    </iron-dropdown>
  </template>

  <script>
    /**
     * `paper-select`
     * paper select element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PaperSelect extends Polymer.Element {
      static get is() { return 'paper-select'; }
      static get properties() {
        return {
          label: {
            type: String,
            value: '...'
          },
          searchText: {
            type: String,
            value: undefined,
            observer: 'onSearch'
          },
          value: {
            type: String,
            notify: true,
            reflectToAttribute: true,
            value: ''
          },
          values: {
            type: Array,
            notify: true,
            reflectToAttribute: true,
            value: () => []
          },
          selectedItems: {
            type: Array,
            value: () => []
          },
          multi: {
            type: Boolean,
            value: false
          },
          focused: {
            type: Boolean,
            value: false
          },
          searchable: {
            type: Boolean,
            value: false
          },
          disabled: {
            type: Boolean,
            value: false
          },
          invalid: {
            type: Boolean,
            value: false,
            notify: true
          },
          required: {
            type: Boolean,
            value: false
          }
        };
      }

      get listeners() {
        return {};
      }

      get behaviors() {
        return [];
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();

        //this.initSelectedAndTap();
        this.$.slot.addEventListener('slotchange', this.initSelectedAndTap.bind(this));

        //this.$.dropdown.positionTarget = this.$.selected;
        this.$.dropdown.style.width = `${ this.$.selected.clientWidth - 4 }px`;
      }

      validate() {
        this.invalid = this.required && (
          this.multi && this.values.length == 0 ||
          !this.multi && !this.value
        ) ? true : false;

        if (this.invalid) {
          this.setAttribute('invalid', '');
        } else {
          this.removeAttribute('invalid');
        }
        
        return !this.invalid;
      }

      open() {
        if (!this.disabled) {
          this.focused = true;
          this.$.dropdown.open();
        }        
      }

      close() {
        this.focused = false;
      }

      onSearch() {
        this.querySelectorAll('[selected]').forEach((item, index, arr) => {
          item.removeAttribute('selected');
        });

        this.querySelectorAll('[option]').forEach((item, index, arr) => {
          if (this.searchText) {
            if (item.getAttribute('label').match(this.searchText)) {
              item.removeAttribute('hidden');
            } else {
              item.setAttribute('hidden', '');
            }            
          } else {
            item.removeAttribute('hidden');
          }
        });

        //this.initSelectedAndTap();
        
        this.dispatchEvent(
          new CustomEvent('search', { detail: this.searchText })
        );
      }

      onDelete(event) {
        if (!this.disabled) {
          let element = Polymer.dom(event).localTarget;
          
          if (element) {
            this.selectItem({
              value: element.getAttribute('value'),
              label: element.getAttribute('label')
            });
          }
        }
      }

      onSelect(event) { 
        let element;

        for (let i = 0, e = event.target; i < 3; i++) {
          if (e.hasAttribute('option')) {
            element = e;
            break;
          } else {
            e = e.parentNode;
          }          
        }

        if (element) {
          this.selectItem({
            value: element.getAttribute('value'),
            label: element.getAttribute('label')
          });
        }
      }

      initSelectedAndTap () {
        var values = [];
        
        if (this.multi) {
          values = this.values;
          this.values = [];
        } else if (this.value) {
          values.push(this.value);
          this.value = '';
        }

        this.querySelectorAll('[selected]').forEach((item, index, arr) => {
          values.push(item.getAttribute('value'));
        });

        values = [...new Set(values)];

        this.querySelectorAll('[option]').forEach((item, index, arr) => {
          //item.removeEventListener('tap', this.onSelect);
          //item.removeAttribute('selected');
          let value = item.getAttribute('value');
          
          if (values.indexOf(value) !== -1) {
            item.setAttribute('selected', '');
            
            if (!this.selectedItems.find(item1 => item1.value == value)) {
              this.selectItem({
                value: item.getAttribute('value'),
                label: item.getAttribute('label')
              });
            }
          }

          if (!item.hasAttribute('tap')) {
            item.addEventListener('tap', this.onSelect.bind(this));
            item.setAttribute('tap', '');
          }
        });
      }

      selectItem(obj) {
        if (obj) {
          let items = [];

          if (this.multi) {
            if (this.selectedItems.find(item => item.value == obj.value)) {
              items = this.selectedItems.filter(item => item.value != obj.value);
            } else {
              items = this.selectedItems;
              items.push(obj);
            }
            
            this.set('values', items.map(item => item.value));
          } else {
            if (this.selectedItems.find(item => item.value == obj.value)) {
              this.value = '';
            } else {
              items = [obj];
              this.value = obj.value;
            }
          }
          
          this.set('selectedItems', items);
          this.$.selected_items.render();
          this.$.dropdown.position();

          this.querySelectorAll('[option]').forEach((item, index, arr) => {
            if (items.find(item1 => item1.value == item.getAttribute('value'))) {
              item.setAttribute('selected', '');
            } else {
              item.removeAttribute('selected');
            }
          });
        }
      }
    }

    window.customElements.define(PaperSelect.is, PaperSelect);
  </script>
</dom-module>

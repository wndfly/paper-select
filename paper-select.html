<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/paper-styles.html">

<dom-module id="paper-select">
  <template>
    <style>
      :host {
        display: block;
      }

      div#selected {
        flex-direction: row;
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px var(--paper-grey-600) solid;
        min-height: 32px;
      }

      div#selected label#label {
        color: var(--paper-grey-600);
        display: block;
        margin: 2px;
        padding: 8px 0;
        width: 100%;
      }

      div#selected[focused] {
        border-bottom: 2px var(--paper-indigo-600) solid;
      }

      div#selected[focused] label#label {
        color: var(--paper-indigo-400);
      }

      div#selected div.item {
        @apply --shadow-elevation-2dp;
        background-color: var(--paper-indigo-600);
        color: var(--paper-indigo-50);
        margin: 2px;
        padding: 8px;
        border-radius: 4px;
        display: flex;
      }

      div#selected div.item span.clear {
        --iron-icon-width: 14px;
        --iron-icon-height: 14px;
        font-weight: bold;
        margin-left: 3px;
        color: var(--paper-pink-300);
        cursor: pointer;
      }

      iron-dropdown#dropdown {
        @apply --shadow-elevation-4dp;
        background-color: var(--paper-grey-50);
        padding: 0 2px 2px;
      }

      iron-dropdown paper-input iron-icon {
        color: var(--paper-grey-600);
      }

      ::slotted([selected]) {
        font-weight: bold;
      }      
    </style>
    
    <div id="selected" slot="dropdown-trigger" on-tap="open" focused$="{{ focused }}">
      <label id="label">{{ label }}</label>
      <dom-repeat items="{{ selectedItems }}" id="selected_items">
        <template>
          <div class="item">
            <span class="content">{{ item.label }}</span>
            <span class="clear">
              <iron-icon icon="close"
                         slot="prefix"
                         value$="{{ item.value }}"
                         on-tap="onDelete">
              </iron-icon>
            </span>
          </div>
        </template>
      </dom-repeat>
    </div>
    
    <iron-dropdown no-overlap horizontal-align="left" vertical-align="top" id="dropdown" on-iron-overlay-closed="close">
      <div slot="dropdown-content">
        <paper-input value="{{ searchText }}" hidden$="{{ !searchable }}" no-label-float type="text">
          <iron-icon icon="search" slot="prefix"></iron-icon>
        </paper-input>
        <div role="listbox">
          <slot></slot>
        </div>
      </div>
    </iron-dropdown>
  </template>

  <script>
    /**
     * `paper-select`
     * paper select element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PaperSelect extends Polymer.Element {
      static get is() { return 'paper-select'; }
      static get properties() {
        return {
          label: {
            type: String,
            value: '请选择...'
          },
          searchText: {
            type: String,
            value: '',
            observer: 'onSearch'
          },
          selectedItems: {
            type: Array,
            value: () => []
          },
          multi: {
            type: Boolean,
            value: false
          },
          towLine: {
            type: Boolean,
            value: false
          },
          focused: {
            type: Boolean,
            value: false
          },
          searchable: {
            type: Boolean,
            value: false
          }
        };
      }

      static get listeners() {
        return {};
      }

      connectedCallback() {
        super.connectedCallback();

        this.querySelectorAll('[option=""]').forEach((item, index, arr) => {
          item.addEventListener('tap', this.onSelect.bind(this));
        });

        this.$.dropdown.positionTarget = this.$.selected;
        this.$.dropdown.style.width = `${ this.$.selected.clientWidth - 4 }px`;
      }

      open() {
        this.focused = true;
        this.$.dropdown.open();
      }

      close() {
        this.focused = false;
      }

      onSearch() {
        this.dispatchEvent(
          new CustomEvent('search', { detail: this.searchText })
        );
      }

      onDelete(event) {
        let element = Polymer.dom(event).localTarget;
        
        if (element) {
          this.selectItem({
            value: element.getAttribute('value'),
            label: element.getAttribute('label')
          });
        }
      }

      onSelect(event) { 
        let element;

        for (let i = 0, e = event.target; i < 3; i++) {
          if (e.hasAttribute('option')) {
            element = e;
            break;
          } else {
            e = e.parentNode;
          }          
        }

        if (element) {
          this.selectItem({
            value: element.getAttribute('value'),
            label: element.getAttribute('label')
          });
        }
      }

      selectItem(obj) {
        if (obj) {
          let items = [];
          let bRet = true;
          
          this.selectedItems.forEach((item, index, arr) => {
            if (item.value == obj.value) {
              bRet = false;
            } else {
              items.push(item);
            }
          });

          if (bRet) {
            if (this.multi) {
              items.push(obj);
            } else {
              items = [obj];
            }
          }

          this.set('selectedItems', items);
          this.$.selected_items.render();
          this.$.dropdown.position();


          this.querySelectorAll('[option=""]').forEach((item, index, arr) =>{
            let bRet = true;

            items.forEach((item1, index1, arr1) => {
              if (item1.value == item.getAttribute('value')) {
                item.setAttribute('selected', '');
                bRet = false;
              }
            });

            if (bRet) {
              item.removeAttribute('selected');
            }
          });
        }
      }
    }

    window.customElements.define(PaperSelect.is, PaperSelect);
  </script>
</dom-module>
